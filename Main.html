<!DOCTYPE HTML>
<html>
    <head>
        <script>
            
            var sizeUnit = 75
            var selectedUnit = -1;
            var units = [] /* Keys: */
            
            function start() {
                for (var i = 0; i < 4; ++i) {
                    for (var j = 0; j < 4; ++j) {
                        var tile = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                        tile.setAttribute("x", String(sizeUnit*i))
                        tile.setAttribute("y", String(sizeUnit*j))
                        tile.setAttribute("width", sizeUnit)
                        tile.setAttribute("height", sizeUnit)
                        tile.setAttribute("fill", "#009")
                        tile.setAttribute("stroke", "#9CF")
                        tile.setAttribute("stroke-width", "3")
                        tile.setAttribute("id", i + "" + j)
                        tile.addEventListener("click", tileClicked)
                        scene.appendChild(tile)
                    }
                }
                createUnit({imageName:"Spaceship", HP:100, player:1, gridLocation:{"x":0,"y":2}})
                createUnit({imageName:"Soldier", HP:100, player:2, gridLocation:{"x":2,"y":1}})
            }
        
        function tileClicked() {
            console.log("foo")
        }
        
        function unitClicked() {
            select(this)
        }
        
        function select(node) {
            if (node == selectedUnit) {
                selectedUnit = -1
                node.setAttribute("href", imageNameForNode(node) + ".png")
            }
            else {
                if (selectedUnit != -1) {
                    select(selectedUnit)
                }
                selectedUnit = node
                node.setAttribute("href", imageNameForNode(node) + " selected.png")
            }
        }
        
        function gridPoint(x, y) {
            return {
                "x": Math.floor(x/sizeUnit),
                "y": Math.floor(y/sizeUnit)
            }
        }
        
        function gridPointForEvent(event) {
            return gridPoint(event.x, event.y)
        }
        
        function gridPointForNode(node) {
            return gridPoint(node.getAttribute("x"), node.getAttribute("y"))
        }
        
        function location(gridPoint) {
            return {
                "x": gridPoint.x*sizeUnit,
                "y": gridPoint.y*sizeUnit
            }
        }
        
        function gridPointsEqual(point1, point2) {
            return ((point1.x == point2.x) && (point1.y == point2.y))
        }
        
        function imageNameForNode(node) {
            return node.getAttribute("href").match(RegExp("[^\\s\\.]*"))[0]
        }
        
        function createUnit(parameters) {
            var unit = document.createElementNS("http://www.w3.org/2000/svg", "image")
            unit.setAttributeNS("http://www.w3.org/1999/xlink", "href", "Resources/Images/"+parameters.imageName+".png")
            unit.setAttribute("height", "75")
            unit.setAttribute("width", "75")
            unit.setAttribute("x", parameters.gridLocation.x*sizeUnit)
            unit.setAttribute("y", parameters.gridLocation.y*sizeUnit)
            unit.setAttribute("preserveAspectRatio", "none")
            units.push({"node":unit, "gridLocation": parameters.gridLocation, "player": parameters.player, "HP": parameters.HP})
            
            unit.setAttribute("id", "Unit " + units.length)
            scene.appendChild(unit)
            
            unit.addEventListener("click", unitClicked)

        }
        
        function enumerate(array, block) {
            for (var i=0; i<array.length; ++i) {
                var shouldContinue = block(array[i])
                if (shouldContinue == false) {break}
            }
        }
        
        function enumerateChildNodes(childNodes, block) {
            function checkingBlock(node) {
                if (node.nodeType == 1) {
                    return block(node)
                }
            }
            enumerate(childNodes, checkingBlock)
        }
        
        </script>
    </head>
    <body onload="start()">
        <svg id="scene" width="300" height="300">
            <image xlink:href="Resources/Images/spaceship.png" width=75 height=75 x=150 y=150 preserveAspectRatio="none">
        </svg>
    </body>
</html>
